<template>
  <div id="ELP-page">
    <div v-if="mode===1">
      <header>
        <h1>è½åŠ›è¤‡ç¿’</h1>
        <h3>æ‰‹å‹•æ·»åŠ  / å¾æ¨™è¨˜å–®å­—ä¸­è¼‰å…¥ä½ è¦è½åŠ›è¤‡ç¿’çš„å–®å­—</h3>
        <h3>å»ºç«‹å¥½ï¼Œæ¥è‘—é»æ“Šå–‡å­é–‹å§‹è†è½</h3>
      <template>
        <div id="ELP-page">
          <div v-if="mode===1">
            <div>
              <h1>è½åŠ›è¤‡ç¿’</h1>
              <h3>æ‰‹å‹•æ·»åŠ  / å¾æ¨™è¨˜å–®å­—ä¸­è¼‰å…¥ä½ è¦è½åŠ›è¤‡ç¿’çš„å–®å­—</h3>
              <h3>å»ºç«‹å¥½ï¼Œæ¥è‘—é»æ“Šå–‡å­é–‹å§‹è†è½</h3>
            </div>

            <!-- æ–°å¢ header controlsï¼šå¯å¾æ¨™è¨˜å–®å­—åŒ¯å…¥æˆ–åœ¨æ­¤è¼¸å…¥ä¸¦åŠ å…¥è©å½™åˆ—è¡¨ -->
            <div class="header-controls">
              <div class="tooltip" @click="loadMarkedWords()">
                <div class="parallel-div">
                  <img src="@/assets/sticky-note.png" alt="">
                  <img class="arrow-down icon" src="@/assets/forward.png"  alt="å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨" >
                </div>
                <span class="tooltiptext">å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨</span>
              </div>

              <div class="header-input">
                <input v-model="vocab" type="text" placeholder="Enter a word or phrase" @keyup.enter="appendVocab()" />
                &nbsp;
                <button @click="appendVocab()">Add to vocabList</button>
                &nbsp;
                <button @click="speak(vocab)">ğŸ”Š</button>
              </div>
            </div>

            <div style="display:flex; gap:18px; align-items:center; justify-content:space-between;">
              <div style="display:flex; gap:12px; align-items:center;">
                <button @click="addVocabList()">æ–°å¢è©å½™åˆ—è¡¨</button>
                <span class="hint">(å»ºç«‹ç¨ç«‹çš„è©å½™æ¸…å–®ï¼ŒåŒ…å«æ–°å¢å–®å­—è¼¸å…¥èˆ‡åŒ¯å…¥æ¨™è¨˜å–®å­—æŒ‰éˆ•)</span>
              </div>
            </div>

.vocab-list-body ul{ padding: 0; list-style: none; margin-top: 6px; }
.vocab-list-body li{ height: 28px; display:flex; align-items:center; gap:8px; }
.vocab-list-card h3{ margin: 0 0 6px 0; font-size: 1rem }
.vocab-list-header input[type="text"]{ padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; }
.vocab-list-header button{ background-color: #3273dc; color: white; border-radius: 6px; padding: 6px; }
.vocab-list-card .list-name-input{ font-weight: bold; padding: 6px; }
.create-list-row{ display:flex; gap:12px; align-items:center; margin:12px 0; }
.hint{ color: #666; }
</style><template>

  <div id="ELP-page">
    <div v-if="mode===1">
      <div>
        <h1>è½åŠ›è¤‡ç¿’</h1>
        <h3>æ‰‹å‹•æ·»åŠ  / å¾æ¨™è¨˜å–®å­—ä¸­è¼‰å…¥ä½ è¦è½åŠ›è¤‡ç¿’çš„å–®å­—</h3>
        <h3>å»ºç«‹å¥½ï¼Œæ¥è‘—é»æ“Šå–‡å­é–‹å§‹è†è½</h3>
      </div>

      <!-- Global header controls (sticky-note + input for legacy list) -->
      <div class="header-controls">
        <div class="tooltip" @click="loadMarkedWords()">
          <div class="parallel-div">
            <img src="@/assets/sticky-note.png" alt="">
            <img class="arrow-down icon" src="@/assets/forward.png"  alt="å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨">
          </div>
          <span class="tooltiptext">å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨</span>
        </div>

        <div class="header-input">
          <input v-model="vocab" type="text" placeholder="Enter a word or phrase" @keyup.enter="appendVocab()" />
          &nbsp;
          <button @click="appendVocab()">Add to vocabList</button>
          &nbsp;
          <button @click="speak(vocab)">ğŸ”Š</button>
        </div>
      </div>

      <!-- Create list button -->
      <div style="display:flex; gap:18px; align-items:center; justify-content:space-between;">
        <div style="display:flex; gap:12px; align-items:center;">
          <button @click="addVocabList()">æ–°å¢è©å½™åˆ—è¡¨</button>
          <span class="hint">(å»ºç«‹ç¨ç«‹çš„è©å½™æ¸…å–®ï¼ŒåŒ…å«æ–°å¢å–®å­—è¼¸å…¥èˆ‡åŒ¯å…¥æ¨™è¨˜å–®å­—æŒ‰éˆ•)</span>
        </div>
      </div>

      <!-- Render lists -->
      <div class="vocab-lists-container">
        <div v-for="list in vocabLists" :key="list.id" class="vocab-list-card">
          <div class="vocab-list-header">
            <div style="display:flex; gap:8px; align-items:center;">
              <div v-if="list.editing">
                <input :id="'listName-' + list.id" v-model="list.nameDraft" type="text" style="font-weight:bold;" />
              </div>
              <div v-else>
                <h3 style="margin:0">{{ list.name }}</h3>
              </div>
              <button @click="toggleEditListName(list)">
                <span v-if="list.editing">ğŸ’¾</span>
                <span v-else>âœï¸</span>
              </button>
            </div>
          </div>

          <!-- per-list controls on a new line -->
          <div class="header-controls vocab-list-controls">
            <div class="tooltip" @click="loadMarkedWordsToList(list)">
              <div class="parallel-div">
                <img src="@/assets/sticky-note.png" alt="">
                <img class="arrow-down icon" src="@/assets/forward.png"  alt="å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨">
              </div>
              <span class="tooltiptext">å°‡æ¨™è¨˜å–®å­—è¼‰å…¥æ­¤è©å½™åˆ—è¡¨</span>
            </div>
            <span>
              <img  class="or-icon" src="@/assets/or-arrows.png" title="å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨ OR æ‰‹å‹•æ·»åŠ å–®å­—åˆ°åˆ—è¡¨"  alt="OR" />
            </span>
            <div class="header-input list-input-area">
              <input :id="'listInput-' + list.id" v-model="list.input" type="text" placeholder="Enter a word & phrase" @keyup.enter="appendVocabToList(list)" />
              <button @click="appendVocabToList(list)">Add to vocabList</button>
              <button @click="speak(list.input)">ğŸ”Š listening</button>
            </div>
          </div>

          <div class="vocab-list-body">
            <ul>
              <li v-for="(w, idx) in list.words" :key="idx">{{ w }}
                <div class="tooltip">
                  <span @click="speak(w)" title="listening vocab">ğŸ”Š</span>
                  <span class="tooltiptext">listening vocab</span>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Legacy list area and controls -->
      <div class="list-title-div">
        <h2>è©å½™åˆ—è¡¨&nbsp;</h2>
        <div class="tooltip">
          <span @click="randomListening">ğŸ²ğŸ”Š</span>
          <span class="tooltiptext">éš¨æ©Ÿå¾åˆ—è¡¨ä¸­æ’¥æ”¾å–®å­—è†è½</span>
        </div>
        &nbsp;|&nbsp; 
        <div class="tooltip">
          <img @click="refreshListeningList" class="refresh_icon" alt="Refresh list" src="@/assets/rotate.png">
          <span class="tooltiptext">åˆ·æ–°åˆ—è¡¨</span>
        </div>
        &nbsp;|&nbsp;&nbsp;&nbsp;   
        <div class="tooltip" @click="loadMarkedWords()">
          <div class="parallel-div">
            <img src="@/assets/sticky-note.png" alt="">
            <img class="arrow-down icon" src="@/assets/forward.png"  alt="å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨" >
          </div>
          <span class="tooltiptext">å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨</span>
        </div>
        <span>
          <img class="or-icon" src="@/assets/or-arrows.png" title="å°‡æ¨™è¨˜å–®å­—è¼‰å…¥è†è½åˆ—è¡¨ OR æ‰‹å‹•æ·»åŠ å–®å­—åˆ°åˆ—è¡¨"  alt="OR" />
        </span>
        <div>
          <input v-model="vocab" type="text" placeholder="Enter a word & phrase"  @keyup.enter="appendVocab()"/>
          &nbsp;
          <button @click="appendVocab()">Add to vocabList</button>&nbsp;
          <button @click="speak(vocab)">ğŸ”Š listening</button>
        </div>
      </div>

      <div id="ListDiv">
        <div>
          <ul>
            <li v-for="(vocabItem, index) in vocabList" :key="index">{{vocabItem}}
              <div class="tooltip">
                <span @click="speak(vocabItem)" title="listening vocab">ğŸ”Š</span>
                <span class="tooltiptext">listening vocab</span>
              </div>
              <div class="tooltip">
                <img class="bin" src="@/assets/bin.png" @click="removeVocab(index)" alt="delete" >
                <span class="tooltiptext">Delete vocab</span>
              </div>
            </li>
          </ul>
        </div>
        <div>
          <ul>
            <li v-for="(vocabItem, index) in listeningList" :key="index">{{vocabItem}}</li>
          </ul>
        </div>
      </div>
      <hr>
      <h2>éš¨æ©Ÿè†è½æ¸¬é©—</h2>
    </div>
    <div v-else>
      <h3>æ¸¬è©¦</h3>
    </div>
  </div>

</template>

<script setup>
import { ref, nextTick } from 'vue'
import api from '@/axios.js'

// State
const mode = ref(1)
const vocab = ref('')
const vocabList = ref([]) // legacy global list
const listeningList = ref([])
const listeningVocab = ref('')

// multiple vocab lists
const vocabLists = ref([])
const nextVocabListId = ref(1)
const activeVocabListId = ref(null)

// Methods
function speak(text){
  if(!text) return
  const utterance = new SpeechSynthesisUtterance(text)
  utterance.lang = 'en-US'
  speechSynthesis.speak(utterance)
}

function randomListening(){
  if (listeningList.value.length === 0){
    alert('è†è½åˆ—è¡¨å·²ç©ºï¼Œè«‹å…ˆæ–°å¢è©å½™')
    return
  }
  const randomIndex = Math.floor(Math.random() * listeningList.value.length)
  listeningVocab.value = listeningList.value[randomIndex]
  listeningList.value.splice(randomIndex, 1)
  speak(listeningVocab.value)
}

function appendVocab(){
  const v = (vocab.value || '').trim()
  if (v === ''){ alert('è«‹è¼¸å…¥è¦æ·»åŠ çš„å–®å­—!'); return }
  vocabList.value.push(v)
  vocab.value = ''
  listeningList.value = [...vocabList.value]
}

function appendVocabToList(list){
  const value = (list.input || '').trim()
  if (value === ''){ alert('è«‹è¼¸å…¥è¦æ·»åŠ çš„å–®å­—!'); return }
  list.words.push(value)
  list.input = ''
}

function addVocabList(){
  const id = nextVocabListId.value++
  const list = {
    id,
    name: `List ${id}`,
    words: [],
    input: '',
    editing: true,
    nameDraft: `List ${id}`
  }
  vocabLists.value.push(list)
  activeVocabListId.value = id
  nextTick(()=>{
    const el = document.getElementById('listName-' + id)
    if (el) el.focus()
  })
}

async function loadMarkedWordsToList(list){
  try{
    const response = await api.get('/markedwords')
    response.data.words.forEach((item)=>{
      if (!list.words.includes(item.word)) list.words.push(item.word)
    })
  }catch(err){
    console.error('è¼‰å…¥æ¨™è¨˜å–®å­—å¤±æ•—', err)
  }
}

function refreshListeningList(){
  listeningList.value = [...vocabList.value]
}
function reListening(){
  speak(listeningVocab.value)
}

function removeVocab(vocabIndex){
  const word = vocabList.value[vocabIndex]
  const index = listeningList.value.indexOf(word)
  if (index !== -1){
    const lastIndex = listeningList.value.length - 1
    const lastWord = listeningList.value[lastIndex]
    listeningList.value[index] = lastWord
    listeningList.value.pop()
  }
  vocabList.value.splice(vocabIndex, 1)
}

async function loadMarkedWords(){
  try{
    const response = await api.get('/markedwords')
    response.data.words.forEach((item)=>{
      listeningList.value.push(item.word)
      vocabList.value.push(item.word)
    })
  }catch(err){
    console.error('æ¨™è¨˜å–®å­—è¼‰å…¥è©å½™åˆ—è¡¨å¤±æ•—', err)
  }
}

function toggleEditListName(list){
  if (list.editing){
    const name = (list.nameDraft || '').trim()
    if (name === ''){ alert('åˆ—è¡¨åç¨±ä¸å¯ç‚ºç©º'); return }
    list.name = name
    list.editing = false
  } else {
    list.nameDraft = list.name
    list.editing = true
    nextTick(()=>{
      const el = document.getElementById('listName-' + list.id)
      if (el) el.focus()
    })
  }
}

</script>

<style scoped>

input[type="text"] {
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

button {
  padding: 10px 20px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.refresh_icon{
  height: 25px;
  width: 25px;
  cursor: pointer;
}



li{
  height: 30px;
  display: flex;
  align-items: center;  /* å‚ç›´ç½®ä¸­ */
}

ul{
  list-style: none;
  padding: 0;
  margin: 0;
}

#ELP-page {
  background-color: rgba(255, 255, 255, 0.8);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  margin-top: 5vw;
}

.bin{
  height: 20px;
  width: 20px;
  cursor: pointer;
  vertical-align: middle;
}

#ListDiv{
  display: flex;
  /* align-items: center;  å‚ç›´ç½®ä¸­ */
  align-items: flex-start; /* è®“å…©å€‹å­divéƒ½é ä¸Šå°é½Š */
  gap: 20px;               /* ä¿æŒé–“è·ï¼Œå¯ä¾éœ€è¦èª¿æ•´ */
}

.or-icon{
  margin: 10px 40px;
  height: 30px;
  width: 40px;
  display: block;
  cursor: pointer;
}


.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltiptext {
  visibility: hidden;
  background-color: black;
  color: white;
  text-align: center;
  padding: 4px 8px;
  border-radius: 4px;
  position: absolute;
  z-index: 1;
  bottom: 100%; /* é¡¯ç¤ºåœ¨ä¸Šæ–¹ */
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.2s;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}


.arrow-down {
  transform: rotate(90deg);
  height: 25px;
  width: 25px;
  cursor: pointer;
  margin-top: 7px;
  margin-left: 5px;
}

.header-controls{
  display: flex;
  gap: 16px;
  align-items: center;
  margin-top: 12px;
}

.header-input input[type="text"]{
  padding: 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
}

.header-input button{
  padding: 8px 12px;
  border-radius: 4px;
}

.vocab-lists-container{
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
}

.vocab-list-card{
  border: 2px solid #cddbf7;
  padding: 10px;
  border-radius: 8px;
  background: #fff;
}

.vocab-list-card:hover{
  box-shadow: 0 2px 8px rgba(12, 60, 120, 0.06);
}

.vocab-list-header input[type="text"]{
  padding: 6px 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.vocab-list-header button{ background-color: #3273dc; color: white; border-radius: 6px; padding: 6px; }

.vocab-list-header{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap: 12px;
}

.vocab-list-controls{ display:flex; gap:12px; align-items:center; margin-top:8px }
.vocab-list-controls{ flex-wrap: nowrap }
.list-input-area{ display:flex; gap:8px; align-items:center; flex-wrap: nowrap }
.list-input-area input[type="text"]{ min-width: 160px; max-width: 320px; }

.vocab-list-body ul{ padding: 0; list-style: none; margin-top: 6px; }
.vocab-list-body li{ height: 28px; display:flex; align-items:center; gap:8px; }

.vocab-list-card h3{ margin: 0 0 6px 0; font-size: 1rem }

.list-title-div{
  display: flex;
  align-items: center;   /* å‚ç›´ç½®ä¸­ */
}

.listening-div{
  text-align: left;

}




</style>